<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∂Ô∏è Prik Jinda Log (v3.0)</title>
    <style>
        :root {
            --primary-color: #022344;
            --accent-color: #f44336; 
            --success-color: #2e7d32;
            --error-color: #d32f2f;
            --warn-color: #ffc107;
            --bg-light: #f4f7f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: var(--bg-light); color: #333; line-height: 1.6; }
        .container { width: 95%; max-width: 1100px; margin: 20px auto; }
        
        /* ---------------------------------- */
        /* --- Utilities & Buttons --- */
        /* ---------------------------------- */
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 20px; }
        h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-top: 30px; }
        button, .button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover, .button:hover { background-color: #003366; }
        button:active, .button:active { transform: scale(0.98); }
        
        .btn-delete { background-color: var(--error-color); }
        .btn-delete:hover { background-color: #b71c1c; }
        .btn-edit { background-color: var(--warn-color); color: #333; }
        .btn-edit:hover { background-color: #ffa000; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
        }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        /* ---------------------------------- */
        /* --- Card & List Styling --- */
        /* ---------------------------------- */
        .card { background: #fff; border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .list-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        .list-item:hover { background-color: #f9f9f9; }
        .list-item-content { flex-grow: 1; cursor: pointer; }
        .list-item-actions { display: flex; gap: 8px; }
        .list-item-actions button { width: auto; padding: 5px 10px; font-size: 0.85em; }

        /* ---------------------------------- */
        /* --- Collapsible <details> --- */
        /* ---------------------------------- */
        details {
            background: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        details summary {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
            list-style-position: inside;
        }
        details[open] summary { border-bottom: 1px solid var(--border-color); }
        .details-content { padding: 20px; }

        /* ---------------------------------- */
        /* --- Table Styling --- */
        /* ---------------------------------- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px 10px; text-align: left; }
        th { background-color: var(--primary-color); color: white; }
        td .btn-edit, td .btn-delete { width: auto; padding: 5px 10px; font-size: 0.9em; margin-right: 5px; }
        .income { color: var(--success-color); font-weight: 500; }
        .expense { color: var(--error-color); font-weight: 500; }
        .summary { background-color: #e0f7fa; padding: 20px; display: flex; flex-wrap: wrap; justify-content: space-around; text-align: center; gap: 15px; }
        .profit { color: var(--primary-color); font-weight: bold; font-size: 1.4em; }
        .profit.negative { color: var(--error-color); }

        /* ---------------------------------- */
        /* --- Modal Styling --- */
        /* ---------------------------------- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 600px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .close-btn {
            color: #aaa; position: absolute; top: 15px; right: 25px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-btn:hover { color: #000; }

        /* ---------------------------------- */
        /* --- Audit Log Styling --- */
        /* ---------------------------------- */
        #auditLogList { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; }
        .log-item { padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.85em; }
        .log-item strong { color: var(--primary-color); }
        .log-item .action-UPDATE { color: #ff9800; }
        .log-item .action-CREATE { color: var(--success-color); }
        .log-item .action-DELETE { color: var(--error-color); }

        /* ---------------------------------- */
        /* --- Mobile Optimization --- */
        /* ---------------------------------- */
        @media (max-width: 768px) {
            .input-row { grid-template-columns: 1fr; }
            .summary { flex-direction: column; }
            .list-item { flex-direction: column; align-items: flex-start; }
            .list-item-content { margin-bottom: 10px; }
            .modal-content { width: 95%; margin: 20% auto; }
            
            /* Responsive Table (Simplified) */
            .table-wrapper { border: none; box-shadow: none; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 40%; text-align: right; min-height: 30px; }
            td:before { position: absolute; top: 6px; left: 6px; width: 35%; padding-right: 10px; white-space: nowrap; content: attr(data-label); font-weight: bold; text-align: left; color: var(--primary-color); }
            td[data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"] { text-align: center; padding-left: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="mainTitle">üå∂Ô∏è Project Financial Log</h1>
        <button id="backButton" style="width: auto; padding: 8px 15px; margin-bottom: 15px; display: none;" onclick="showProjectList()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
        <h2 id="currentProjectName" style="text-align: center; color: var(--accent-color); border: none; padding: 0; margin: 0;"></h2>
    </header>

    <div id="projectListView">
        <details class="card" open>
            <summary>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</summary>
            <div class="details-content">
                <form id="newProjectForm">
                    <div class="form-group">
                        <label for="new_project_name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô: ‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏£‡∏¥‡∏Å‡∏õ‡∏µ 2026)</label>
                        <input type="text" id="new_project_name" required>
                    </div>
                    <div class="form-group">
                        <label for="new_project_description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Optional)</label>
                        <input type="text" id="new_project_description">
                    </div>
                    <button type="submit">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
                </form>
            </div>
        </details>
        
        <h2>üìÇ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div id="projectListContainer">
            </div>
    </div>


    <div id="transactionView" style="display: none;">
        
        <details class="card">
            <summary>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</summary>
            <div class="details-content">
                <form id="transactionForm">
                    <div class="input-row">
                        <div class="form-group">
                            <label for="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                            <select id="type" required onchange="filterCategories('category_id', this.value)">
                                <option value="Expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                                <option value="Income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category_id">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                            <select id="category_id" required>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
                            <input type="number" id="amount" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (optional):</label>
                        <input type="text" id="description" maxlength="200">
                    </div>
                    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </form>
            </div>
        </details>

        <details class="card">
            <summary>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</summary>
            <div class="details-content summary">
                <div>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: <span id="totalIncome" class="income">0.00 ‡∏ö‡∏≤‡∏ó</span></div>
                <div>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span id="totalExpense" class="expense">0.00 ‡∏ö‡∏≤‡∏ó</span></div>
                <div>**‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:** <span id="netProfit" class="profit">0.00 ‡∏ö‡∏≤‡∏ó</span></div>
            </div>
        </details>

        <div class="card">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody"></tbody>
                </table>
            </div>
        </div>

        <details class="card">
            <summary>üóÇÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</summary>
            <div class="details-content">
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="newCategoryForm" class="input-row">
                    <input type="text" id="new_category_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà" required style="flex-grow: 2;">
                    <select id="new_category_type">
                        <option value="Expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="Income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                    </select>
                    <button type="submit" style="width: auto;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </form>
                <hr>
                <h3>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</h3>
                <div id="categoryListContainer">
                    </div>
            </div>
        </details>

        <details class="card">
            <summary>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Log)</summary>
            <div class="details-content">
                <ul id="auditLogList">
                    </ul>
            </div>
        </details>
    </div>

</div>

<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-modal="projectEditModal">&times;</span>
        <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
        <form id="projectEditForm">
            <input type="hidden" id="edit_project_id">
            <div class="form-group">
                <label for="edit_project_name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                <input type="text" id="edit_project_name" required>
            </div>
            <div class="form-group">
                <label for="edit_project_description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                <input type="text" id="edit_project_description">
            </div>
            <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
    </div>
</div>

<div id="categoryEditModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-modal="categoryEditModal">&times;</span>
        <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
        <form id="categoryEditForm">
            <input type="hidden" id="edit_category_id_modal">
            <div class="form-group">
                <label for="edit_category_name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" id="edit_category_name" required>
            </div>
            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <input type="text" id="edit_category_type" disabled style="background:#eee;">
            </div>
            <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
    </div>
</div>

<div id="txEditModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-modal="txEditModal">&times;</span>
        <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
        <form id="txEditForm">
            <input type="hidden" id="edit_tx_id">
            <div class="input-row">
                <div class="form-group">
                    <label for="edit_tx_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                    <select id="edit_tx_type" required onchange="filterCategories('edit_tx_category_id', this.value)">
                        <option value="Expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="Income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_tx_category_id">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                    <select id="edit_tx_category_id" required></select>
                </div>
                <div class="form-group">
                    <label for="edit_tx_amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
                    <input type="number" id="edit_tx_amount" step="0.01" min="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit_tx_description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</label>
                <input type="text" id="edit_tx_description" maxlength="200">
            </div>
            <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
    </div>
</div>


<script>
    // Global State
    let currentProjectId = null;
    let allCategories = [];
    let allTransactions = [];

    // DOM Views
    const projectListView = document.getElementById('projectListView');
    const transactionView = document.getElementById('transactionView');
    const backButton = document.getElementById('backButton');
    const mainTitle = document.getElementById('mainTitle');
    const currentProjectName = document.getElementById('currentProjectName');

    // DOM Elements
    const projectListContainer = document.getElementById('projectListContainer');
    const newProjectForm = document.getElementById('newProjectForm');
    const transactionForm = document.getElementById('transactionForm');
    const tableBody = document.getElementById('transactionTableBody');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const netProfitEl = document.getElementById('netProfit');
    const categorySelect = document.getElementById('category_id');
    const typeSelect = document.getElementById('type');
    const auditLogList = document.getElementById('auditLogList');
    const newCategoryForm = document.getElementById('newCategoryForm');
    const categoryListContainer = document.getElementById('categoryListContainer');

    // Modals
    const projectEditModal = document.getElementById('projectEditModal');
    const categoryEditModal = document.getElementById('categoryEditModal');
    const txEditModal = document.getElementById('txEditModal');

    // API Helper
    async function apiRequest(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            if (response.status === 204) return null; // No Content
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            return null;
        }
    }

    // ----------------------------------
    // --- VIEW MANAGEMENT
    // ----------------------------------
    function showProjectList() {
        currentProjectId = null;
        mainTitle.textContent = 'üå∂Ô∏è Project Financial Log';
        currentProjectName.textContent = '';
        backButton.style.display = 'none';
        projectListView.style.display = 'block';
        transactionView.style.display = 'none';
        fetchProjects();
    }

    async function showTransactionView(projectId, projectName) {
        currentProjectId = projectId;
        mainTitle.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢';
        currentProjectName.textContent = `‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${projectName}`;
        backButton.style.display = 'block';
        projectListView.style.display = 'none';
        transactionView.style.display = 'block';
        
        // Load data
        await fetchCategories();
        await fetchTransactions();
        await fetchLogs();
    }

    // ----------------------------------
    // --- PROJECTS (CRUD)
    // ----------------------------------
    async function fetchProjects() {
        projectListContainer.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</p>';
        const projects = await apiRequest('/api/projects');
        projectListContainer.innerHTML = '';
        if (!projects || projects.length === 0) {
            projectListContainer.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£! ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p>';
            return;
        }
        projects.forEach(p => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <div class="list-item-content" onclick="showTransactionView(${p.id}, '${p.name}')">
                    <span class="project-name">${p.name}</span>
                    <br><small>${p.description}</small>
                </div>
                <div class="list-item-actions">
                    <button class="btn-edit" onclick="showProjectEditModal(${p.id}, '${p.name}', '${p.description}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-delete" onclick="handleDeleteProject(${p.id}, '${p.name}')">‡∏•‡∏ö</button>
                </div>
            `;
            projectListContainer.appendChild(item);
        });
    }

    newProjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new_project_name').value.trim();
        const description = document.getElementById('new_project_description').value.trim();
        if (!name) return;

        const result = await apiRequest('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description }),
        });
        if (result) {
            alert(`‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${name}" ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            newProjectForm.reset();
            fetchProjects();
        }
    });

    function showProjectEditModal(id, name, description) {
        document.getElementById('edit_project_id').value = id;
        document.getElementById('edit_project_name').value = name;
        document.getElementById('edit_project_description').value = description;
        projectEditModal.style.display = 'block';
    }

    document.getElementById('projectEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_project_id').value;
        const name = document.getElementById('edit_project_name').value.trim();
        const description = document.getElementById('edit_project_description').value.trim();
        
        const result = await apiRequest(`/api/projects/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description }),
        });
        if (result) {
            closeModal(projectEditModal);
            fetchProjects();
        }
    });

    async function handleDeleteProject(id, name) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${name}"?\n\n‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡∏∞ Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!`)) return;
        
        const result = await apiRequest(`/api/projects/${id}`, { method: 'DELETE' });
        if (result !== null) { // DELETE returns 200 OK with message
            alert(result.message);
            fetchProjects();
        }
    }

    // ----------------------------------
    // --- CATEGORIES (CRUD)
    // ----------------------------------
    async function fetchCategories() {
        if (!currentProjectId) return;
        allCategories = await apiRequest(`/api/projects/${currentProjectId}/categories`);
        
        // ‡∏Å‡∏£‡∏≠‡∏á Dropdown ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏Å
        filterCategories('category_id', typeSelect.value);
        
        // üü¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"
        renderCategoryList();
    }

    function renderCategoryList() {
        categoryListContainer.innerHTML = '';
        if (!allCategories || allCategories.length === 0) {
            categoryListContainer.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</p>';
            return;
        }
        allCategories.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <div class="list-item-content">
                    <span class="${cat.type.toLowerCase()}">${cat.name}</span>
                    <small>(${cat.type})</small>
                </div>
                <div class="list-item-actions">
                    <button class="btn-edit" onclick="showCategoryEditModal(${cat.id}, '${cat.name}', '${cat.type}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-delete" onclick="handleDeleteCategory(${cat.id}, '${cat.name}')">‡∏•‡∏ö</button>
                </div>
            `;
            categoryListContainer.appendChild(item);
        });
    }

    function filterCategories(dropdownId, selectedType) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        const filtered = allCategories.filter(cat => cat.type === selectedType);
        dropdown.innerHTML = '';
        
        if (filtered.length === 0) {
            dropdown.innerHTML = '<option value="" disabled>--- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ---</option>';
            return;
        }
        filtered.forEach(cat => {
            dropdown.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        });
    }

    newCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new_category_name').value.trim();
        const type = document.getElementById('new_category_type').value;
        
        const result = await apiRequest(`/api/projects/${currentProjectId}/categories`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, type }),
        });
        if (result) {
            document.getElementById('new_category_name').value = '';
            fetchCategories(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            fetchLogs(); // ‡πÇ‡∏´‡∏•‡∏î Log
        }
    });

    function showCategoryEditModal(id, name, type) {
        document.getElementById('edit_category_id_modal').value = id;
        document.getElementById('edit_category_name').value = name;
        document.getElementById('edit_category_type').value = type;
        categoryEditModal.style.display = 'block';
    }

    document.getElementById('categoryEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_category_id_modal').value;
        const name = document.getElementById('edit_category_name').value.trim();
        
        const result = await apiRequest(`/api/categories/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name }),
        });
        if (result) {
            closeModal(categoryEditModal);
            fetchCategories();
            fetchLogs();
        }
    });

    async function handleDeleteCategory(id, name) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}"?`)) return;
        
        const result = await apiRequest(`/api/categories/${id}`, { method: 'DELETE' });
        if (result !== null) {
            alert(result.message);
            fetchCategories();
            fetchLogs();
        }
    }

    // ----------------------------------
    // --- TRANSACTIONS (CRUD)
    // ----------------------------------
    async function fetchTransactions() {
        if (!currentProjectId) return;
        allTransactions = await apiRequest(`/api/projects/${currentProjectId}/transactions`);
        renderTable(allTransactions || []);
        renderSummary(allTransactions || []);
    }

    function renderTable(transactions) {
        tableBody.innerHTML = '';
        if (transactions.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
            return;
        }
        transactions.forEach(t => {
            const date = new Date(t.date_recorded).toLocaleDateString('th-TH');
            const typeClass = t.type.toLowerCase();
            
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">${date}</td>
                <td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" class="${typeClass}">${t.type === 'Income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</td>
                <td data-label="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">${t.category_name}</td>
                <td data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="${typeClass}">${parseFloat(t.amount).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                <td data-label="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">${t.description || '-'}</td>
                <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">
                    <button class="btn-edit" onclick="showTxEditModal(${t.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-delete" onclick="handleDeleteTx(${t.id})">‡∏•‡∏ö</button>
                </td>
            `;
        });
    }

    function renderSummary(transactions) {
        let totalIncome = 0;
        let totalExpense = 0;
        transactions.forEach(t => {
            if (t.type === 'Income') { totalIncome += t.amount; } 
            else { totalExpense += t.amount; }
        });
        const netProfit = totalIncome - totalExpense;

        totalIncomeEl.textContent = totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
        totalExpenseEl.textContent = totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
        netProfitEl.textContent = netProfit.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
        netProfitEl.classList.toggle('negative', netProfit < 0);
    }

    // CREATE
    transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            type: typeSelect.value,
            category_id: document.getElementById('category_id').value,
            amount: parseFloat(document.getElementById('amount').value),
            description: document.getElementById('description').value.trim()
        };
        
        const result = await apiRequest(`/api/projects/${currentProjectId}/transactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        if (result) {
            transactionForm.reset();
            fetchTransactions(); 
            fetchLogs();
        }
    });

    // UPDATE
    function showTxEditModal(transactionId) {
        const tx = allTransactions.find(t => t.id === transactionId);
        if (!tx) return;

        document.getElementById('edit_tx_id').value = tx.id;
        document.getElementById('edit_tx_type').value = tx.type;
        document.getElementById('edit_tx_amount').value = tx.amount;
        document.getElementById('edit_tx_description').value = tx.description || '';
        
        filterCategories('edit_tx_category_id', tx.type);
        document.getElementById('edit_tx_category_id').value = tx.category_id;
        
        txEditModal.style.display = 'block';
    }

    document.getElementById('txEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_tx_id').value;
        const data = {
            type: document.getElementById('edit_tx_type').value,
            category_id: document.getElementById('edit_tx_category_id').value,
            amount: parseFloat(document.getElementById('edit_tx_amount').value),
            description: document.getElementById('edit_tx_description').value.trim()
        };

        const result = await apiRequest(`/api/transactions/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        if (result) {
            closeModal(txEditModal);
            fetchTransactions(); 
            fetchLogs();
        }
    });

    // DELETE
    async function handleDeleteTx(transactionId) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ID: ${transactionId} ?`)) return;
        
        const result = await apiRequest(`/api/transactions/${transactionId}`, { method: 'DELETE' });
        if (result !== null) {
            alert(result.message);
            fetchTransactions(); 
            fetchLogs();
        }
    }

    // ----------------------------------
    // --- AUDIT LOG
    // ----------------------------------
    async function fetchLogs() {
        if (!currentProjectId) return;
        auditLogList.innerHTML = '<li class="log-item">Loading logs...</li>';
        const logs = await apiRequest(`/api/projects/${currentProjectId}/logs`);
        
        auditLogList.innerHTML = '';
        if (!logs || logs.length === 0) {
            auditLogList.innerHTML = '<li class="log-item">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</li>';
            return;
        }
        logs.forEach(log => {
            const date = new Date(log.timestamp).toLocaleString('th-TH');
            const li = document.createElement('li');
            li.className = 'log-item';
            li.innerHTML = `
                ${date} - <strong>${log.user_name}</strong> 
                <span class="action-${log.action}">[${log.action}]</span>: 
                ${log.details || `Record ID ${log.record_id}`}
            `;
            auditLogList.appendChild(li);
        });
    }

    // ----------------------------------
    // --- MODAL HELPERS
    // ----------------------------------
    function closeModal(modal) {
        if (modal) modal.style.display = 'none';
    }
    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° (x)
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.onclick = () => closeModal(document.getElementById(btn.dataset.modal));
    });
    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target);
        }
    };

    // ----------------------------------
    // --- INITIALIZATION
    // ----------------------------------
    showProjectList(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
</script>

</body>
</html>